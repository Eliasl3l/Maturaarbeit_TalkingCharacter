{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Recognition</title>
</head>
<body>

<!-- Display status -->
<div id="status">welcome to the talking character</div>

<!-- Button to start speech recognition -->
<button onclick="recognition.start()">Start Listening</button>

<!-- JavaScript for handling speech recognition and communication with server -->
<script>
    // Initialize the Web Speech API
    let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

    recognition.onstart = function() {
        // Indicate that recognition has started
        document.getElementById("status").innerText = "Listening...";
    };

    recognition.onresult = function(event) {
        let transcript = event.results[0][0].transcript;

        // Indicate that speech was recognized
        document.getElementById("status").innerText = "Recognized: " + transcript;

        sendDataToServer(transcript);
    };

    function sendDataToServer(transcript) {
        // Indicate that the data is being sent to the server
        document.getElementById("status").innerText = "Sending to server...";

        fetch('/process_transcript/', {
            method: 'POST',
            body: JSON.stringify({
                'transcript': transcript
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // Ensure CSRF token is sent for Django
            }
        })
        .then(response => response.json())
        .then(data => {
            // Access video_link from the data object
            let video_link = data.video_link;
            if (video_link !== undefined) {
                document.getElementById("videosource").src = video_link;
            } 
            else {
                console.error("Video link is undefined");
                document.getElementById("status").innerText = "Error: Video link is undefined";
            }
            let videoplayer = document.getElementById("videoplayer");
            videoplayer.load();
            videoplayer.play();
            // Indicate that the server has processed the data
            document.getElementById("status").innerText = "Incoming data was processed by server";
        })
        .catch(error => {
            // Indicate if there's an error
            document.getElementById("status").innerText = "Error: " + error;
        })

        var socket = new WebSocket('ws://a3ae-2a02-aa16-517b-2000-d867-6b56-c9af-30ae.ngrok-free.app/ws/mywebsocket');

        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);
            if (data.video_link) {
                var videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.src = data.video_link;
                videoPlayer.load();
                videoPlayer.play();
            }
        };
    
        socket.onopen = function(event) {
            console.log('WebSocket connection established');
        };
    
        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

}





    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Page</title>
</head>
<body>
    <video id="videoplayer" width="520" height="520" controls>
        <source id="videosource" src="{{ video_link }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    
</body>
<head>
    <style>
        #statusBar {
            width: 100%;
            height: 30px;
            border: 1px solid black;
            background-color: #e9e9e9;
            position: fixed;
            bottom: 30;
            left: 0;
            padding: 5px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }
    </style>

</head>
    <div id="statusBar">
        <span id="statusText">Loading...</span>
    </div>
    <script>
        function updateStatus() {
            fetch('/get_server_status/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('statusText').textContent = data.status;
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                document.getElementById('statusText').textContent = 'Error fetching status';
            });
    
            // Fetch every 60 seconds (you can adjust the interval as needed)
            setTimeout(updateStatus, 60000);
        }
    
        // Start the status update loop
        updateStatus();
    </script>
    
</body>
</html>
